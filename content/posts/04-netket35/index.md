---
title: "NetKet 3.5 highlights"
date: 2022-08-19T10:23:16+01:00
draft: false
author: Filippo Vicentini
mintoclevel = 2
maxtoclevel = 3

---

After 4 months of intense work, we are happy to officially release version 3.5 of NetKet! We would like to thank all contributors to this release and all of you who opened issues and bug reports, helping us to improve the quality of NetKet.

As always, the full list of changes can be found in the [changelog](https://netket.readthedocs.io/en/latest/docs/changelog.html), but here we will discuss more in depth some of the highlights of this last release.

## Dynamics for wavefunctions with real parameters

** Filippo Vicentini and Damian Hoffmann**

Up to now, NetKet had an annoying limitation that would prevent you from simulating the dynamics with Neural Quantum States that had real parameters, or that were non-holomorphic.
As most autoregressive networks are non-holomorphic, that's quite a strong limitation.

This limitation emerged because if parameters are real, NetKet's [`expect_and_grad`](https://netket.readthedocs.io/en/latest/api/_generated/vqs/netket.vqs.MCState.html?highlight=expect_and_gad#netket.vqs.MCState.expect_and_grad) function returns the real-part of the gradient of expectation values.
However, to perform the dynamics in those cases we would need the imaginary part of this object (see Table 1, Eq. 12 of [Xiao Yuan's Theory of Variational Dynamics](https://arxiv.org/abs/1812.08767) for a more in-depth discussion).

In NetKet 3.5, we finally address this shortcoming by adding a new function called [`expect_and_forces`](https://netket.readthedocs.io/en/latest/api/_generated/vqs/netket.vqs.MCState.html?highlight=expect_and_gad#netket.vqs.MCState.expect_and_forces), which behaves similarly to [`expect_and_grad`](https://netket.readthedocs.io/en/latest/api/_generated/vqs/netket.vqs.MCState.html?highlight=expect_and_gad#netket.vqs.MCState.expect_and_grad) but returns the so-called _variational forces_ generated by the given operator. 
The forces are (in most cases) a complex-valued PyTree object that behaves like the gradient, and its imaginary part can be used to generate the TDVP Equation.

Using this new function, the TDVP Equation can be integrated using a loop like the following:

```python
def custom_simple_tdvp(
    hamiltonian: AbstractOperator,  # Hamiltonian
    vstate: VariationalState,       # variational state
    t0: float,                      # initial time
    dt: float,                      # time step
    t_end: float,                   # end time
):
    t = t0
    while t < t_end:
        # compute the forces `f` generated by the Hamiltonian
        energy, f = vstate.expect_and_forces(hamiltonian)
        G = vstate.quantum_geometric_tensor()
        # multiply the gradient by -1.0j for unitary dynamics
        gamma_f = jax.tree_map(lambda x: -1.0j * x, f)
        # take the real part of -1.0*f if the parameters are real
        gamma_f = jax.tree_map(
	        lambda x, target: (x if jnp.iscomplexobj(target) else x.real),
	        gamma_f,
	        vstate.parameters,
	    )
        # Solve the linear system using any solver, such as CG
        # (or write your own regularization scheme)
        dtheta, _ = G.solve(jax.scipy.sparse.linalg.cg, gamma_f)
        # update the parameters (theta = theta + dt * dtheta)
        vs.parameters = jax.tree_map(
            lambda x, y: x + dt * y, vstate.parameters, dtheta
        )
        t = t + dt
```

(FYI: This snippet is an updated version of one found in the [NetKet's Scipost Codebases Paper](https://scipost.org/preprints/scipost_202112_00047v2/) at page 29. If you want a more detailed discussion, give it a look!)

If you don't want to write the loop yourself, the experimental `TDVP`


## API for computing matrix elements

A long-standing request from NetKet's users was the possibility to compute 


## HDF5 Logger

**[Max Bortone](https://github.com/maxbortone)**

As part of UnitaryHack's hackathon, Max has implemented a new logger that uses HDF5 to store all data such as observables and networks parameters to a single, extensible file.

The logger can be used 





